{"version":3,"file":"idle-state.js","sources":["../src/utils.js","../src/index.js"],"sourcesContent":["export const isFunction = (fn) => typeof fn === 'function'\r\n\r\nexport const isObject = (obj) =>\r\n  Object.prototype.toString.call(obj) === '[object Object]'\r\n\r\nexport const isArray = (obj) =>\r\n  Object.prototype.toString.call(obj) === '[object Array]'\r\n\r\n// unique array item\r\nexport const uniqueArray = (arr) => {\r\n  if (!isArray(arr)) {\r\n    return []\r\n  }\r\n\r\n  const ret = []\r\n  for (let i = 0; i < arr.length; i++) {\r\n    if (arr.indexOf(arr[i]) === i) {\r\n      ret.push(arr[i])\r\n    }\r\n  }\r\n  return ret\r\n}\r\n\r\nexport const next = (callback) => isFunction(callback) && callback()\r\n\r\nexport const noop = () => {}\r\n","import {\r\n  isArray,\r\n  isFunction,\r\n  isObject,\r\n  uniqueArray,\r\n  next,\r\n  noop,\r\n} from './utils.js'\r\n\r\nconst STATUS_START = 1\r\nconst STATUS_PAUSE = 2\r\nconst STATUS_STOP = 3\r\n\r\nclass Detector {\r\n  static events = [\r\n    'scroll',\r\n    'keydown',\r\n    'touchmove',\r\n    'touchstart',\r\n    'click',\r\n    // 'mousedown',\r\n    // 'wheel',\r\n    // 'mousewheel',\r\n    // 'mousemove',\r\n  ]\r\n\r\n  isIdle = false\r\n  timer = null\r\n  status = STATUS_START\r\n  currentTaskIndex = 0\r\n\r\n  eventHandler = this.eventHandler.bind(this)\r\n\r\n  constructor(task, options = {}) {\r\n    if (isObject(task)) {\r\n      Object.assign(options, task)\r\n    }\r\n\r\n    if (isArray(task)) {\r\n      if (isArray(options.tasks)) {\r\n        options.tasks = task.concat(options.tasks)\r\n      } else {\r\n        options.tasks = task\r\n      }\r\n    }\r\n\r\n    // transform all tasks to a task array\r\n    if (isFunction(task)) {\r\n      if (isArray(options.tasks)) {\r\n        options.tasks = [task].concat(options.tasks)\r\n      } else {\r\n        options.tasks = [task]\r\n      }\r\n    }\r\n\r\n    const { events } = options\r\n    if (isArray(events)) {\r\n      Detector.events = Detector.events.concat(events)\r\n    }\r\n\r\n    this.options = {\r\n      target: document.body,\r\n      timeout: 3000,\r\n      interval: 1000,\r\n      loop: false,\r\n      enableMousemove: false,\r\n      tasks: [],\r\n      events: [],\r\n      onDispose: noop,\r\n      onPause: noop,\r\n      onResume: noop,\r\n      ...options,\r\n    }\r\n\r\n    /**\r\n     * mousemove events are frequently triggered in the browser,\r\n     * so put it configurable\r\n     */\r\n    if (this.options.enableMousemove) {\r\n      Detector.events.push('mousemove')\r\n    }\r\n\r\n    // remove repeat event\r\n    Detector.events = uniqueArray(Detector.events)\r\n\r\n    const element = this.options.target\r\n\r\n    Detector.events.forEach((event) => {\r\n      element.addEventListener(event, this.eventHandler)\r\n    })\r\n\r\n    this.start()\r\n  }\r\n\r\n  // controller of running tasks\r\n  run() {\r\n    const { tasks, loop } = this.options\r\n\r\n    if (this.status !== STATUS_START) {\r\n      return\r\n    }\r\n\r\n    if (!tasks.length) {\r\n      this.dispose()\r\n    }\r\n\r\n    const isLastTask = this.currentTaskIndex === tasks.length - 1\r\n\r\n    const task = tasks[this.currentTaskIndex]\r\n\r\n    next(task)\r\n\r\n    if (loop && isLastTask) {\r\n      this.currentTaskIndex = 0\r\n      this.start()\r\n    }\r\n\r\n    if (!loop && isLastTask) {\r\n      this.dispose()\r\n    }\r\n\r\n    if (!isLastTask) {\r\n      this.currentTaskIndex++\r\n      this.start()\r\n    }\r\n  }\r\n\r\n  /**\r\n   * pause running tasks\r\n   * callback passed by this has a higher priority than options\r\n   * @param {Function} cb\r\n   */\r\n  pause(cb) {\r\n    if (this.status === STATUS_START) {\r\n      this.status = STATUS_PAUSE\r\n      const callback = cb || this.options.onPause\r\n      next(callback)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * resume paused tasks\r\n   * callback passed by this has a higher priority than options\r\n   * @param {Function} cb\r\n   */\r\n  resume(cb) {\r\n    if (this.status === STATUS_PAUSE) {\r\n      this.status = STATUS_START\r\n      const callback = cb || this.options.onResume\r\n      next(callback)\r\n      this.start()\r\n    }\r\n  }\r\n\r\n  clearTimer() {\r\n    if (this.timer) {\r\n      clearTimeout(this.timer)\r\n      this.timer = null\r\n    }\r\n  }\r\n\r\n  eventHandler() {\r\n    this.isIdle = false\r\n    this.start()\r\n  }\r\n\r\n  // start running tasks\r\n  start() {\r\n    this.clearTimer()\r\n\r\n    const { interval, timeout } = this.options\r\n\r\n    const time = this.isIdle ? interval : timeout\r\n\r\n    this.timer = setTimeout(() => {\r\n      this.isIdle = true\r\n      this.run()\r\n    }, time)\r\n  }\r\n\r\n  // dispose the resource & remove events handler\r\n  dispose(cb) {\r\n    this.status = STATUS_STOP\r\n    this.clearTimer()\r\n    const element = this.options.target\r\n    Detector.events.forEach((evt) => {\r\n      element.removeEventListener(evt, this.eventHandler)\r\n    })\r\n    const callback = cb || this.options.onDispose\r\n    next(callback)\r\n  }\r\n\r\n  // convenience options for `dispose` API\r\n  stop(...args) {\r\n    this.dispose.apply(this, args)\r\n  }\r\n\r\n  // convenience options for `dispose` API\r\n  destroy(...args) {\r\n    this.dispose.apply(this, args)\r\n  }\r\n\r\n  // push a task\r\n  push(task) {\r\n    if (isFunction(task)) {\r\n      this.options.tasks.push(task)\r\n    }\r\n  }\r\n\r\n  // set tasks running timeout\r\n  timeout(timeout) {\r\n    this.options.timeout = timeout\r\n  }\r\n\r\n  // set task running interval\r\n  interval(interval) {\r\n    this.options.interval = interval\r\n  }\r\n\r\n  // set loop option\r\n  loop(value) {\r\n    this.options.loop = value\r\n  }\r\n}\r\n\r\nexport default function (...args) {\r\n  return new Detector(...args)\r\n}\r\n"],"names":["isFunction","fn","isObject","obj","Object","prototype","toString","call","isArray","uniqueArray","arr","ret","i","length","indexOf","push","next","callback","noop","STATUS_START","STATUS_PAUSE","STATUS_STOP","Detector","task","options","eventHandler","bind","assign","tasks","concat","events","target","document","body","timeout","interval","loop","enableMousemove","onDispose","onPause","onResume","element","forEach","event","addEventListener","start","status","dispose","isLastTask","currentTaskIndex","cb","timer","clearTimeout","isIdle","clearTimer","time","setTimeout","run","evt","removeEventListener","args","apply","value"],"mappings":"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"}